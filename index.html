<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FridgeMind — Scan & Track</title>
<style>
  :root{
    --pink:#ffb6c1; --pink-d:#ff9eb3; --warn-bg:#ffd1dc;
    --card:#fff; --shadow:0 4px 14px rgba(0,0,0,0.08);
  }
  body{
    margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: linear-gradient(135deg,#ffe7f0 0%,#e7f6ff 100%);
    color:#333; padding:24px;
  }
  h1{ text-align:center; margin:6px 0 18px; color:#ff6f9a; }
  .wrap{ max-width:720px; margin:0 auto; }
  .card{ background:var(--card); border-radius:16px; padding:18px; box-shadow:var(--shadow); }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  input[type="text"], input[type="date"]{
    padding:10px 12px; border-radius:12px; border:1px solid #f3dbe2; font-size:14px; flex:1;
  }
  .file-wrap{ display:flex; gap:8px; align-items:center; width:100%; }
  .file-input{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid #f3dbe2; }
  button{
    background:var(--pink); color:white; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
  }
  button.secondary{ background:#fff; color:#333; border:1px solid #f3dbe2; }
  button:disabled{ opacity:.6; transform:none; cursor:default; }
  .items{ margin-top:16px; display:flex; flex-direction:column; gap:10px; }
  .item-card{ background:#fff; border-radius:12px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,.05); display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
  .info{ display:flex; flex-direction:column; gap:6px; min-width:220px; }
  .name{ font-weight:700; font-size:15px; }
  .expiry{ color:#666; font-size:14px; }
  .badge{ background:var(--warn-bg); color:#9b1b2b; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px; }
  .suggest{ font-size:13px; color:#666; font-style:italic; }
  .used-btn{ background:var(--pink); color:#fff; border-radius:999px; padding:8px 14px; border:none; cursor:pointer; }
  .used-card{ background:#dff3e9 !important; }
  .note{ margin-top:8px; font-size:13px; color:#666; }
  .small{ font-size:12px; color:#777; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#222; color:#fff; padding:8px 14px; border-radius:999px; font-size:13px; z-index:999; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>🥕 FridgeMind — Scan & Track</h1>

    <div class="card">
      <div style="display:flex;gap:10px;flex-direction:column;">
        <div class="row">
          <input id="itemName" type="text" placeholder="Enter item name (or scan) 🍅" />
          <input id="expiryDate" type="date" />
          <button id="addBtn">➕ Add</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="file-wrap" style="flex:1;">
            <input id="fileInput" class="file-input" type="file" accept="image/*" />
          </div>
          <button id="scanBtn" title="Scan uploaded image">📷 Scan</button>
        </div>

        <div class="note small">Upload/take a photo ➜ click <strong>Scan</strong> to detect item. Then set expiry and Add.</div>
      </div>
    </div>

    <div class="items" id="itemList"></div>
  </div>

<script>
/* Pantry data */
const pantry = {
  "tomato":   { emoji:"🍅", recipes:["Tomato Chutney","Tomato Rasam","Tomato Rice"] },
  "onion":    { emoji:"🧅", recipes:["Onion Chutney","Onion Pakora","Onion Sambar"] },
  "potato":   { emoji:"🥔", recipes:["Aloo Curry","Aloo Paratha","Jeera Aloo"] },
  "carrot":   { emoji:"🥕", recipes:["Carrot Halwa","Carrot Poriyal"] },
  "bread":    { emoji:"🍞", recipes:["Bread Upma","Bread Pakora"] },
  "milk":     { emoji:"🥛", recipes:["Make Paneer","Kheer"] },
  "rice":     { emoji:"🍚", recipes:["Lemon Rice","Curd Rice"] },
  "egg":      { emoji:"🥚", recipes:["Egg Curry","Egg Bhurji"] }
};
const aliases = { "tomatoes":"tomato","potatoes":"potato" };

function normalize(s){ return (s||"").toString().trim().toLowerCase(); }
function findPantryKeyFromLabel(label){
  if(!label) return null;
  const L = normalize(label);
  if(aliases[L]) return aliases[L];
  if(pantry[L]) return L;
  for(const key of Object.keys(pantry)){
    if(L.includes(key)) return key;
  }
  return null;
}

/* UI refs */
const fileInput = document.getElementById('fileInput');
const scanBtn = document.getElementById('scanBtn');
const itemNameInput = document.getElementById('itemName');
const expiryInput = document.getElementById('expiryDate');
const addBtn = document.getElementById('addBtn');
const itemList = document.getElementById('itemList');
let lastSelectedFile = null;

fileInput.addEventListener('change', (e)=> lastSelectedFile = e.target.files[0] || null);

function showToast(msg){
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 2500);
}

/* File to base64 */
function fileToBase64NoPrefix(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result.split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* Scan handler */
scanBtn.addEventListener('click', async ()=>{
  if(!lastSelectedFile){ showToast("Choose/take a photo first"); return; }
  scanBtn.disabled = true;
  scanBtn.textContent = 'Scanning…';
  try{
    const b64 = await fileToBase64NoPrefix(lastSelectedFile);
    const res = await fetch("/api/vision", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: b64 })
    });
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const labels = data.labelAnnotations || [];
    const fullText = data.textAnnotations?.[0]?.description || "";
    let match = null;
    for(const l of labels){
      const mapped = findPantryKeyFromLabel(l.description);
      if(mapped){ match = mapped; break; }
    }
    if(match){
      itemNameInput.value = `${pantry[match].emoji} ${match.charAt(0).toUpperCase()+match.slice(1)}`;
      showToast(`Detected: ${match}`);
    } else if(fullText){
      itemNameInput.value = fullText.split('\n')[0];
      showToast(`Detected text: ${itemNameInput.value}`);
    } else {
      showToast("Couldn't detect a usable label.");
    }
  } catch(err){
    console.error(err);
    showToast("Scan failed — check backend/API key.");
  } finally {
    scanBtn.disabled = false;
    scanBtn.textContent = '📷 Scan';
  }
});

/* Add item */
addBtn.addEventListener('click', addItem);
function addItem(){
  const raw = (itemNameInput.value || "").trim();
  const expiry = expiryInput.value;
  if(!raw || !expiry){ showToast("Enter name & expiry"); return; }

  const keyTry = findPantryKeyFromLabel(raw.toLowerCase()) || null;
  const dleft = daysUntil(expiry);
  const card = document.createElement('div');
  card.className = 'item-card';

  const info = document.createElement('div');
  info.className = 'info';
  if(dleft <= 3){
    const b = document.createElement('div');
    b.className = 'badge';
    b.textContent = `⚠️ Near Expiry (${dleft}d)`;
    info.appendChild(b);
  }
  const nameLine = document.createElement('div');
  nameLine.className = 'name';
  nameLine.textContent = raw;
  info.appendChild(nameLine);

  const expiryLine = document.createElement('div');
  expiryLine.className = 'expiry';
  expiryLine.textContent = `Expiry: ${expiry}`;
  info.appendChild(expiryLine);

  if(dleft <= 3 && keyTry){
    const pool = pantry[keyTry].recipes;
    const pick = pool[Math.floor(Math.random()*pool.length)];
    const link = `https://www.youtube.com/results?search_query=${encodeURIComponent(pick + ' recipe')}`;
    const s = document.createElement('div');
    s.className = 'suggest';
    s.innerHTML = `🍳 Suggestion: <a href="${link}" target="_blank">${pick}</a>`;
    info.appendChild(s);
  }

  const button = document.createElement('button');
  button.className = 'used-btn';
  button.textContent = '✅ Used';
  button.addEventListener('click', ()=>{
    card.classList.add('used-card');
    info.innerHTML = `${raw} 🌟 Used!`;
    button.remove();
  });

  card.appendChild(info);
  card.appendChild(button);
  itemList.prepend(card);

  itemNameInput.value = '';
  expiryInput.value = '';
  fileInput.value = '';
  lastSelectedFile = null;
}

function daysUntil(dateStr){
  const t = new Date();
  const e = new Date(dateStr);
  return Math.ceil((e - t) / (1000*60*60*24));
}
</script>
</body>
</html>
