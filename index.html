<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FridgeMind ‚Äî Cute Waste Reducer (Camera)</title>
<style>
  :root{
    --pink:#ffb6c1; --pink-d:#ff9eb3; --badge:#ff8c69;
    --warn-bg:#ffd1dc; --card:#ffffff; --shadow:0 3px 8px rgba(0,0,0,.12);
  }
  body{ margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(135deg,#ffe5ec 0%,#f3f7ff 50%,#e0f7fa 100%); color:#333; }
  h1{ text-align:center; margin:20px 10px; color:#444; }
  .container{ max-width:820px; margin:0 auto 64px; padding:16px; }
  .inputs, .camera-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:16px; }
  input, button{ padding:10px 14px; border-radius:20px; border:1px solid #f1d9e1; font-size:14px; outline:none; }
  input[type="text"]{ min-width:180px; } input[type="date"]{ min-width:150px; }
  .btn{ background:var(--pink); color:#fff; border:none; cursor:pointer; transition:.2s; }
  .btn:hover{ background:var(--pink-d); transform:translateY(-1px); }
  .panel{ background:var(--card); border-radius:20px; padding:16px; box-shadow:var(--shadow); margin:10px auto; }
  .panel h2{ margin:0 0 8px 0; font-size:16px; color:#555; }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .thumb{ width:120px; height:120px; border-radius:16px; object-fit:cover; background:#f6f6f6; border:1px dashed #e6c9d4; }
  .note{ font-size:12px; color:#666; }
  /* Item card */
  .item-card{ background:var(--card); border-radius:20px; padding:16px; margin:10px auto;
    box-shadow:var(--shadow); display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
  .item-info{ display:flex; flex-direction:column; align-items:flex-start; gap:6px; min-width:240px; }
  .expiry-badge{ background:var(--badge); color:#fff; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:600; display:inline-block; }
  .item-name{ font-weight:700; font-size:16px; }
  .expiry-date{ font-size:14px; color:#444; letter-spacing:.2px; }
  .recipe-suggestion{ font-size:14px; color:#666; font-style:italic; }
  .recipe-suggestion a{ color:inherit; text-decoration:none; border-bottom:1px dotted #aaa; }
  .done-button{ background:var(--pink); color:#fff; cursor:pointer; padding:8px 14px; border-radius:999px; border:none; font-size:14px; align-self:flex-start; transition:.2s; }
  .done-button:hover{ background:var(--pink-d); transform:translateY(-1px); }
  .used{ background:#d3f8e2 !important; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#222; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; opacity:.95; }
</style>
</head>
<body>
  <h1>ü•ï FridgeMind ‚Äî Cute Waste Reducer (Camera)</h1>
  <div class="container">

    <!-- Add item (manual) -->
    <div class="panel">
      <h2>‚ûï Add Item</h2>
      <div class="inputs">
        <input id="itemName" type="text" placeholder="Enter item name (e.g., Tomato)"/>
        <input id="itemExpiry" type="date"/>
        <button class="btn" id="addBtn">Add Item</button>
      </div>
      <div class="note">Tip: If it‚Äôs near expiry (‚â§ 3 days), you‚Äôll see a badge and a cute recipe idea üç≥.</div>
    </div>

    <!-- Camera scan -->
    <div class="panel">
      <h2>üì∏ Camera Scan (real ‚Äî Google Vision)</h2>
      <div class="camera-row">
        <input id="cameraInput" type="file" accept="image/*" capture="environment" />
        <img id="preview" class="thumb" alt="Preview"/>
        <button class="btn" id="scanBtn">Scan Photo</button>
      </div>
      <div class="note">Mobile opens camera directly. Scanned label will auto-fill the item name field. Works over HTTPS.</div>
    </div>

    <!-- Items -->
    <div id="itemList"></div>
  </div>

<script>
/* Pantry (emojis + small recipe pools) */
const pantry = {
  "tomato":   {emoji:"üçÖ", recipes:["Tomato Rasam","Tomato Chutney","Tomato Rice","Tomato Pachadi"]},
  "onion":    {emoji:"üßÖ", recipes:["Onion Pakora","Onion Sambar","Ulli Theeyal","Onion Chutney"]},
  "potato":   {emoji:"ü•î", recipes:["Aloo Paratha","Dum Aloo","Jeera Aloo","Aloo Curry"]},
  "carrot":   {emoji:"ü•ï", recipes:["Carrot Halwa","Carrot Poriyal","Carrot Thoran","Carrot Fry"]},
  "cabbage":  {emoji:"ü•¨", recipes:["Cabbage Poriyal","Cabbage Thoran","Patta Gobi Sabzi"]},
  "beans":    {emoji:"ü´ò", recipes:["Beans Poriyal","Beans Usili","Beans Stir Fry"]},
  "brinjal":  {emoji:"üçÜ", recipes:["Baingan Bharta","Ennai Kathirikai","Brinjal Curry"]},
  "cauliflower": {emoji:"üå∏", recipes:["Aloo Gobi","Gobi Manchurian (dry)","Gobi Masala"]},
  "chilli":   {emoji:"üå∂Ô∏è", recipes:["Mirchi Bajji","Green Chilli Pickle","Stuffed Chilli"]},
  "garlic":   {emoji:"üßÑ", recipes:["Garlic Chutney","Lahsun Pickle","Lahsun Dal"]},
  "ginger":   {emoji:"üå±", recipes:["Inji Puli","Ginger Tea","Ginger Chutney"]},
  "lemon":    {emoji:"üçã", recipes:["Lemon Rice","Nimbu Pickle","Lemon Rasam"]},
  "curd":     {emoji:"üç∂", recipes:["Curd Rice","Mor Kuzhambu","Boondi Raita"]},
  "milk":     {emoji:"ü•õ", recipes:["Kheer","Paneer (at home)","Milk Halwa"]},
  "paneer":   {emoji:"üßÄ", recipes:["Paneer Butter Masala","Palak Paneer","Paneer Bhurji"]},
  "spinach":  {emoji:"ü•¨", recipes:["Palak Paneer","Keerai Poriyal","Dal Palak"]},
  "mango":    {emoji:"ü•≠", recipes:["Mango Pickle","Aamras","Mango Lassi"]},
  "banana":   {emoji:"üçå", recipes:["Banana Halwa","Banana Smoothie","Pazham Pori"]},
  "egg":      {emoji:"ü•ö", recipes:["Egg Curry","Egg Bhurji","Masala Omelette"]},
  "rice":     {emoji:"üçö", recipes:["Lemon Rice","Curd Rice","Veg Pulao"]},
  "dal":      {emoji:"üç≤", recipes:["Dal Tadka","Sambar","Paruppu Curry"]},
  "coconut":  {emoji:"ü••", recipes:["Coconut Chutney","Thengai Sadam","Coconut Ladoo"]},
  "tamarind": {emoji:"üü§", recipes:["Puliyodarai","Imli Chutney","Puli Kuzhambu"]},
  "wheat flour": {emoji:"ü´ì", recipes:["Chapati","Paratha","Poori"]}
};

/* Expand matching: synonyms & plural handling */
const aliases = {
  "tomatoes":"tomato", "chillies":"chilli", "chilies":"chilli", "aubergine":"brinjal",
  "eggplant":"brinjal", "curds":"curd", "yogurt":"curd", "yoghurt":"curd",
  "capsicum":"chilli", "bell pepper":"chilli", "greens":"spinach", "spinach leaves":"spinach",
  "cauli":"cauliflower", "ladyfinger":"okra", "okra":"ladyfinger" // okra not in pantry by default; add if you like
};

/* Utility */
function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function daysUntil(dateStr){
  const today = stripTime(new Date());
  const exp = new Date(dateStr);
  if(isNaN(exp)) return Infinity;
  return Math.ceil((exp - today) / (1000*60*60*24));
}
function matchKey(raw){
  let name = raw.trim().toLowerCase();
  if(aliases[name]) name = aliases[name];
  if(pantry[name]) return name;
  for(const key of Object.keys(pantry)){
    if(name.includes(key) || key.includes(name)) return key;
  }
  return null;
}

/* UI toast */
let toastT = null;
function toast(msg){
  if(toastT) clearTimeout(toastT);
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  toastT = setTimeout(()=>{ t.remove(); toastT=null; }, 2200);
}

/* Add item card (manual or after scan) */
function addItem(){
  const nameEl = document.getElementById('itemName');
  const dateEl = document.getElementById('itemExpiry');
  const rawName = nameEl.value.trim();
  const expiry = dateEl.value;
  if(!rawName || !expiry) { toast('Enter name & expiry date'); return; }

  const key = matchKey(rawName);
  const pretty = rawName.charAt(0).toUpperCase() + rawName.slice(1);
  const dleft = daysUntil(expiry);

  const card = document.createElement('div');
  card.className = 'item-card';
  if(dleft <= 3) card.style.background = 'var(--warn-bg)';

  const info = document.createElement('div');
  info.className = 'item-info';

  if(dleft <= 3){
    const badge = document.createElement('span');
    badge.className = 'expiry-badge';
    badge.textContent = '‚ö†Ô∏è Near Expiry';
    info.appendChild(badge);
  }

  const nameLine = document.createElement('span');
  nameLine.className = 'item-name';
  const emoji = key ? pantry[key].emoji : 'üçΩÔ∏è';
  nameLine.textContent = `${emoji} ${pretty}`;
  info.appendChild(nameLine);

  const dateLine = document.createElement('span');
  dateLine.className = 'expiry-date';
  dateLine.textContent = `Expiry: ${expiry}`;
  info.appendChild(dateLine);

  if(dleft <= 3 && key){
    const pool = pantry[key].recipes;
    const pick = pool[Math.floor(Math.random()*pool.length)];
    const q = encodeURIComponent(`${pick} recipe`);
    const link = `https://www.youtube.com/results?search_query=${q}`;
    const sugg = document.createElement('span');
    sugg.className = 'recipe-suggestion';
    sugg.innerHTML = `üç≥ Suggestion: <a href="${link}" target="_blank" rel="noopener">${pick}</a>`;
    info.appendChild(sugg);
  }

  const btn = document.createElement('button');
  btn.className = 'done-button';
  btn.textContent = '‚úÖ Used';
  btn.addEventListener('click', () => {
    card.classList.add('used');
    info.innerHTML = `${emoji} ${pretty} üåü Used!`;
  });

  card.appendChild(info);
  card.appendChild(btn);
  document.getElementById('itemList').appendChild(card);

  document.getElementById('itemName').value = '';
  document.getElementById('itemExpiry').value = '';
}

/* Hook up actions */
document.getElementById('addBtn').addEventListener('click', addItem);
document.getElementById('itemName').addEventListener('keydown', e => { if(e.key==='Enter') addItem(); });
document.getElementById('itemExpiry').addEventListener('keydown', e => { if(e.key==='Enter') addItem(); });

/* Camera: preview, scan, fill name */
const cameraInput = document.getElementById('cameraInput');
const preview = document.getElementById('preview');
let imageB64 = null;

cameraInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  const dataUrl = await fileToDataURL(file);
  preview.src = dataUrl;
  imageB64 = dataUrl.split(',')[1]; // base64 only
});

document.getElementById('scanBtn').addEventListener('click', async ()=>{
  if(!imageB64){ toast('Choose/take a photo first'); return; }
  toast('Scanning‚Ä¶');
  try{
    // call your serverless function (same origin). Adjust path if needed.
    const res = await fetch('/api/vision', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ image: imageB64 })
    });
    if(!res.ok) throw new Error('Scan failed');
    const data = await res.json();
    const labels = (data.labels || []).map(s => s.toLowerCase());
    // Try best match against pantry (with aliases)
    let chosen = null;
    for(const s of labels){
      chosen = matchKey(s);
      if(chosen) break;
      if(aliases[s]) { chosen = aliases[s]; break; }
    }
    if(chosen){
      document.getElementById('itemName').value = chosen.charAt(0).toUpperCase() + chosen.slice(1);
      toast(`Detected: ${document.getElementById('itemName').value}`);
    } else {
      // fall back to top label
      const top = labels[0] || 'Item';
      document.getElementById('itemName').value = top.charAt(0).toUpperCase() + top.slice(1);
      toast(`Detected: ${document.getElementById('itemName').value}`);
    }
  }catch(err){
    console.error(err);
    toast('Couldn‚Äôt scan image. Try again.');
  }
});

/* Helpers */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
</script>
</body>
</html>
